<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>HeatControl</title>
  <style>
    :root {
      --bg-0: #0f1419;
      --bg-1: #151c24;
      --panel-0: #1c252f;
      --panel-1: #26323e;
      --line: #3b4a59;
      --text: #eaf2f7;
      --muted: #9db0bf;
      --warm: #ff6262;
      --shadow: rgba(0, 0, 0, 0.44);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Bahnschrift", "Segoe UI", sans-serif;
      color: var(--text);
      background:
        radial-gradient(120% 90% at 0% 0%, rgba(94, 199, 255, 0.16), transparent 58%),
        radial-gradient(120% 110% at 100% 100%, rgba(255, 92, 92, 0.14), transparent 62%),
        repeating-linear-gradient(90deg, rgba(255, 255, 255, 0.03) 0 1px, transparent 1px 22px),
        linear-gradient(180deg, var(--bg-0), var(--bg-1));
    }

    .app {
      width: 100%;
      max-width: 460px;
      margin: 0 auto;
      padding: 12px 12px 18px;
      display: grid;
      gap: 10px;
    }

    .card {
      border: 1px solid var(--line);
      border-radius: 16px;
      background: linear-gradient(180deg, var(--panel-0), var(--panel-1));
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08), 0 10px 24px var(--shadow);
      padding: 12px;
      animation: rise 320ms ease both;
    }

    .topline {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 6px;
    }

    .hero-logo {
      width: min(82%, 320px);
      max-width: 320px;
      height: auto;
      object-fit: contain;
      filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.38));
    }

    .mode-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .lang-btn {
      border: 1px solid #5f7183;
      border-radius: 999px;
      background: rgba(20, 28, 35, 0.85);
      color: #d6e1e9;
      font-size: 0.68rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      padding: 4px 10px;
      min-height: 28px;
    }

    .mode-pill {
      border: 1px solid rgba(57, 208, 152, 0.62);
      border-radius: 999px;
      background: rgba(57, 208, 152, 0.18);
      color: #ddfff1;
      padding: 4px 10px;
      font-size: 0.72rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      cursor: pointer;
      user-select: none;
    }

    .mode-pill.help-open {
      background: rgba(57, 208, 152, 0.3);
    }

    .mode-help {
      margin-bottom: 8px;
      border: 1px dashed #576a7d;
      border-radius: 10px;
      background: rgba(18, 25, 32, 0.86);
      padding: 8px;
      font-size: 0.72rem;
      color: #c6d1da;
      line-height: 1.32;
      display: grid;
      gap: 5px;
    }

    .mode-help.hidden {
      display: none;
    }

    .mode-help b {
      color: #f0f5f9;
      margin-right: 4px;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 7px;
    }

    .summary-item {
      border: 1px solid #495869;
      border-radius: 10px;
      background: rgba(14, 19, 24, 0.76);
      text-align: center;
      padding: 7px 4px;
      font-size: 0.7rem;
      color: var(--muted);
    }

    .summary-item b {
      display: block;
      margin-top: 3px;
      color: var(--text);
      font-size: 0.9rem;
    }

    .update-banner {
      margin-top: 8px;
      border: 1px solid rgba(255, 98, 98, 0.65);
      border-radius: 10px;
      background: rgba(255, 98, 98, 0.14);
      color: #ffdada;
      font-size: 0.74rem;
      line-height: 1.35;
      padding: 7px 9px;
      text-align: center;
    }

    .update-banner.hidden {
      display: none;
    }

    .heater-card {
      padding: 12px;
    }

    .heater-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .heater-name {
      font-weight: 700;
      letter-spacing: 0.03em;
      font-size: 0.9rem;
    }

    .heater-title {
      display: grid;
      gap: 4px;
      align-items: start;
    }

    .protect-badge {
      display: inline-block;
      width: fit-content;
      border-radius: 999px;
      border: 1px solid #b87d2a;
      background: rgba(184, 125, 42, 0.2);
      color: #ffe1b7;
      font-size: 0.62rem;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      padding: 2px 8px;
    }

    .protect-badge.active {
      border-color: rgba(255, 92, 92, 0.8);
      background: rgba(255, 92, 92, 0.28);
      color: #ffe0e0;
    }

    .protect-badge.latched {
      border-color: rgba(255, 183, 77, 0.82);
      background: rgba(255, 183, 77, 0.23);
      color: #ffeac9;
    }

    .protect-badge.hidden {
      display: none;
    }

    .status-ring {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      background: conic-gradient(var(--warm) calc(var(--pct) * 1%), #2f3944 0);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
      font-size: 0.72rem;
      font-weight: 700;
      color: #ffd9d9;
    }

    .status-ring span {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      background: #161d24;
      border: 1px solid #536171;
    }

    .control-row {
      display: grid;
      grid-template-columns: 56px 1fr 56px;
      gap: 8px;
      align-items: center;
    }

    .temp-btn {
      height: 56px;
      border: 1px solid #5e6f80;
      border-radius: 12px;
      background: linear-gradient(180deg, #3a4551, #2b333d);
      color: var(--text);
      font-size: 1.42rem;
      font-weight: 700;
      line-height: 1;
      touch-action: manipulation;
    }

    .set-box {
      border: 1px solid #5d6e7f;
      border-radius: 12px;
      background: #151c23;
      text-align: center;
      padding: 9px 8px;
      font-family: "Consolas", monospace;
    }

    .set-temp {
      color: var(--warm);
      font-size: 1.5rem;
      line-height: 1.1;
      font-weight: 700;
    }

    .current-temp {
      margin-top: 4px;
      color: #cad4dc;
      font-size: 0.78rem;
    }

    .slider-wrap {
      margin-top: 9px;
    }

    .heating-slider {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      border: 1px solid #4e5f70;
      background: #121a20;
      outline: none;
      appearance: none;
      -webkit-appearance: none;
    }

    .heating-slider::-webkit-slider-thumb {
      appearance: none;
      -webkit-appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 1px solid #8b6266;
      background: linear-gradient(180deg, #ff9d9d, #ff6262);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.35);
    }

    .heating-slider::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 1px solid #8b6266;
      background: linear-gradient(180deg, #ff9d9d, #ff6262);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.35);
    }

    .slider-meta {
      margin-top: 5px;
      display: flex;
      justify-content: space-between;
      color: var(--muted);
      font-size: 0.68rem;
      letter-spacing: 0.02em;
    }

    .advanced-head {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: center;
    }

    .advanced-toggle {
      width: 100%;
      border: 1px solid #5b6d80;
      border-radius: 10px;
      background: linear-gradient(180deg, #37424d, #2a323c);
      color: var(--text);
      font-size: 0.8rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      padding: 10px;
      text-align: left;
    }

    .help-toggle {
      border: 1px solid #5f7183;
      border-radius: 10px;
      background: rgba(24, 32, 40, 0.9);
      color: #d8e2ea;
      font-size: 0.72rem;
      font-weight: 700;
      letter-spacing: 0.01em;
      padding: 10px 9px;
      min-height: 40px;
    }

    .advanced-panel {
      margin-top: 8px;
      display: grid;
      gap: 10px;
    }

    .advanced-panel.hidden {
      display: none;
    }

    .sub-card {
      border: 1px solid #4f5f6f;
      border-radius: 11px;
      background: rgba(15, 21, 27, 0.78);
      padding: 9px;
    }

    .sub-title {
      margin-bottom: 7px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-size: 0.72rem;
      color: #d1dbe3;
      font-weight: 700;
    }

    .setting-line {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: center;
      border: 1px solid #536374;
      border-radius: 9px;
      background: #1a232b;
      padding: 8px;
      font-size: 0.74rem;
      color: #c8d2da;
    }

    .setting-line b {
      display: block;
      color: #fff;
      font-size: 0.82rem;
      margin-bottom: 2px;
    }

    .switch-mock {
      border: 1px solid #5a6b7c;
      border-radius: 999px;
      overflow: hidden;
      background: #2a343d;
      display: flex;
      min-width: 90px;
      font-size: 0.67rem;
      letter-spacing: 0.03em;
      cursor: pointer;
      user-select: none;
    }

    .switch-mock span {
      padding: 4px 8px;
      color: #bdcad4;
    }

    .switch-mock .active {
      background: rgba(57, 208, 152, 0.22);
      color: #ddfff0;
      border-right: 1px solid #6f7f8f;
    }

    .field {
      margin-bottom: 7px;
    }

    .field:last-child {
      margin-bottom: 0;
    }

    .field label {
      display: block;
      font-size: 0.73rem;
      color: #cfd9e1;
      margin-bottom: 4px;
    }

    .field .mock-input {
      width: 100%;
      border: 1px solid #566777;
      border-radius: 8px;
      background: #1a232b;
      color: #e3eaf0;
      font-size: 0.8rem;
      padding: 8px;
    }

    select.mock-input,
    input.mock-input {
      appearance: none;
      -webkit-appearance: none;
    }

    input.mock-input[type="password"] {
      letter-spacing: 0.08em;
    }

    .switch-mock input {
      display: none;
    }

    .row-two {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .diag-action-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      align-items: stretch;
    }

    .diag-action-row .btn {
      min-height: 42px;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .btn {
      border: 1px solid #5d6f81;
      border-radius: 9px;
      background: linear-gradient(180deg, #394450, #2b333d);
      color: var(--text);
      font-size: 0.77rem;
      padding: 8px;
      min-height: 38px;
    }

    .btn.warn {
      border-color: rgba(255, 120, 104, 0.74);
      color: #ffd7d2;
      background: linear-gradient(180deg, rgba(117, 44, 40, 0.72), rgba(80, 31, 28, 0.72));
    }

    .runtime-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 8px;
    }

    .runtime-grid div {
      border: 1px solid #566777;
      border-radius: 9px;
      background: #1a232b;
      text-align: center;
      padding: 8px;
      font-size: 0.72rem;
      color: var(--muted);
    }

    .runtime-grid b {
      display: block;
      margin-top: 3px;
      color: #fff;
      font-size: 0.92rem;
    }

    .hint {
      border: 1px dashed #566777;
      border-radius: 9px;
      background: #1a232b;
      color: #c2cdd6;
      padding: 8px;
      font-size: 0.74rem;
      line-height: 1.35;
      margin-bottom: 8px;
    }

    .help-text {
      margin-top: 8px;
      border: 1px dashed #5a6c7f;
      border-radius: 8px;
      background: rgba(19, 26, 33, 0.84);
      color: #c8d3dc;
      padding: 7px 8px;
      font-size: 0.72rem;
      line-height: 1.34;
      display: none;
    }

    body.show-help .help-text {
      display: block;
    }

    .diag-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 8px;
    }

    .diag-item {
      border: 1px solid #556677;
      border-radius: 9px;
      background: #1a232b;
      padding: 8px;
      font-size: 0.72rem;
      color: var(--muted);
    }

    .diag-item b {
      display: block;
      margin-top: 2px;
      color: #fff;
      font-size: 0.9rem;
    }

    .serial-preview {
      border: 1px solid #506172;
      border-radius: 8px;
      background: #141b21;
      color: #d6dfe6;
      font-family: "Consolas", monospace;
      font-size: 0.71rem;
      padding: 8px;
      line-height: 1.36;
    }

    .serial-preview.hidden {
      display: none;
    }

    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      bottom: 16px;
      z-index: 30;
      background: rgba(20, 30, 37, 0.95);
      border: 1px solid #5f7386;
      color: #e9f2f7;
      border-radius: 10px;
      padding: 8px 12px;
      font-size: 0.76rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 200ms ease, transform 200ms ease;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    @keyframes rise {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <main class="app">
    <section class="card">
      <div class="topline">
        <img class="hero-logo" src="LOGO.png" alt="HeatControl Logo">
      </div>
      <div class="mode-row">
        <div class="mode-pill" id="modePill" data-i18n="mode_auto">AUTO</div>
        <button type="button" class="lang-btn" id="langToggleBtn">English</button>
      </div>
      <div class="mode-help hidden" id="modeHelpBox">
        <div><b data-i18n="mode_auto_label">AUTO:</b><span data-i18n="mode_auto_desc">Automatische Regelung fuer beide Heizkreise anhand der Solltemperaturen.</span></div>
        <div><b data-i18n="mode_power_label">POWER:</b><span data-i18n="mode_power_desc">Beide Heizkreise werden im Leistungsmodus priorisiert betrieben.</span></div>
        <div><b data-i18n="mode_manual_label">MANUAL:</b><span data-i18n="mode_manual_desc">Manuelle Steuerung fuer beide Heizkreise mit festen Leistungswerten.</span></div>
      </div>
      <div class="summary-grid">
        <div class="summary-item"><span data-i18n="summary_ap_ip">AP IP</span><b>4.3.2.1</b></div>
        <div class="summary-item"><span data-i18n="summary_firmware">Firmware</span><b id="firmwareVersion">-</b></div>
        <div class="summary-item"><span data-i18n="summary_ssid">WLAN</span><b id="summarySsid">-</b></div>
      </div>
      <div class="update-banner hidden" id="updateBanner"></div>
    </section>

    <section class="card heater-card">
      <div class="heater-head">
        <div class="heater-title">
          <div class="heater-name" data-i18n="heater1_title">Heizung 1</div>
          <div class="protect-badge hidden" id="heater1ProtectBadge"></div>
        </div>
        <div class="status-ring" id="statusRing1" style="--pct:0"><span id="status1Pct">0%</span></div>
      </div>
      <div class="control-row">
        <button type="button" class="temp-btn" id="temp1DownBtn">-</button>
        <div class="set-box">
          <div class="set-temp"><span id="targetTemp1Display">23.0</span> C</div>
          <div class="current-temp" id="currentTemp1Display">Ist 0.0 C</div>
        </div>
        <button type="button" class="temp-btn" id="temp1UpBtn">+</button>
      </div>
      <div class="slider-wrap">
        <input type="range" class="heating-slider" id="temp1Slider" min="10" max="45" step="0.5" value="23.0">
        <div class="slider-meta"><span>10 C</span><span data-i18n="slider_target">Sollwert</span><span>45 C</span></div>
      </div>
    </section>

    <section class="card heater-card">
      <div class="heater-head">
        <div class="heater-title">
          <div class="heater-name" data-i18n="heater2_title">Heizung 2</div>
          <div class="protect-badge hidden" id="heater2ProtectBadge"></div>
        </div>
        <div class="status-ring" id="statusRing2" style="--pct:0"><span id="status2Pct">0%</span></div>
      </div>
      <div class="control-row">
        <button type="button" class="temp-btn" id="temp2DownBtn">-</button>
        <div class="set-box">
          <div class="set-temp"><span id="targetTemp2Display">23.0</span> C</div>
          <div class="current-temp" id="currentTemp2Display">Ist 0.0 C</div>
        </div>
        <button type="button" class="temp-btn" id="temp2UpBtn">+</button>
      </div>
      <div class="slider-wrap">
        <input type="range" class="heating-slider" id="temp2Slider" min="10" max="45" step="0.5" value="23.0">
        <div class="slider-meta"><span>10 C</span><span data-i18n="slider_target">Sollwert</span><span>45 C</span></div>
      </div>
    </section>

    <section class="card" id="advancedCard">
      <div class="advanced-head">
        <button type="button" class="advanced-toggle" id="advancedToggle">Erweitert anzeigen</button>
        <button type="button" class="help-toggle" id="helpToggleBtn">Hilfe anzeigen</button>
      </div>
      <div class="advanced-panel hidden" id="advancedPanel">
        <div class="sub-card" id="sensorSection">
          <div class="sub-title" data-i18n="sensor_title">Sensor-Zuordnung</div>
          <div class="setting-line">
            <div><b data-i18n="sensor_swap_title">Temperaturfuehler tauschen</b><span data-i18n="sensor_swap_desc">Bei vertauschter Verkabelung aktivieren.</span></div>
            <label class="switch-mock" for="swapSensorsInput"><input type="checkbox" id="swapSensorsInput"><span id="swapOffLabel" class="active" data-i18n="off">AUS</span><span id="swapOnLabel" data-i18n="on">EIN</span></label>
          </div>
          <div class="help-text" data-i18n="help_sensor_swap">Nur aktivieren, wenn Heizung 1/2 offensichtlich vertauscht reagieren.</div>
        </div>

        <div class="sub-card" id="wifiSection">
          <div class="sub-title" data-i18n="wifi_title">WLAN Einstellungen</div>
          <div class="field">
            <label data-i18n="wifi_ssid">Netzwerkname (SSID)</label>
            <input class="mock-input" id="ssidInput" maxlength="31" value="HeatControl">
          </div>
          <div class="field">
            <label data-i18n="wifi_pass">Passwort</label>
            <input class="mock-input" id="passwordInput" type="password" maxlength="31" value="">
          </div>
          <button type="button" class="btn" id="saveWifiBtn" data-i18n="wifi_save">WLAN speichern (mit Neustart)</button>
          <div class="help-text" data-i18n="help_wifi">Nach dem WLAN-Speichern ist ein Neustart notwendig, damit die neuen Daten aktiv werden.</div>
          <div class="help-text" data-i18n="help_captive_desktop">Desktop ohne Auto-Weiterleitung: im Browser direkt http://4.3.2.1 oeffnen.</div>
        </div>

        <div class="sub-card">
          <div class="sub-title" data-i18n="runtime_title">System Laufzeit</div>
          <div class="runtime-grid">
            <div><span data-i18n="runtime_total">Gesamtlaufzeit</span><b id="runtimeTotal">0m</b></div>
            <div><span data-i18n="runtime_current">Aktuelle Laufzeit</span><b id="runtimeCurrent">0s</b></div>
          </div>
          <button type="button" class="btn warn" id="resetRuntimeBtn" data-i18n="runtime_reset">Gesamtlaufzeit zuruecksetzen</button>
          <div class="help-text" data-i18n="help_runtime_reset">Diese Aktion setzt nur den Laufzeitzaehler zurueck. Heizparameter bleiben unveraendert.</div>
        </div>

        <div class="sub-card">
          <div class="sub-title" data-i18n="ota_title">Firmware Update (OTA)</div>
          <div class="hint" data-i18n="ota_hint">Lade eine neue firmware.bin hoch, um das Geraet zu aktualisieren.</div>
          <div class="row-two" style="margin-bottom:8px;">
            <button type="button" class="btn" id="checkUpdateBtn" data-i18n="update_check_btn">Auf Update pruefen</button>
            <button type="button" class="btn" id="autoUpdateBtn" data-i18n="update_auto_btn">Automatisch aktualisieren</button>
          </div>
          <button type="button" class="btn" id="otaOpenBtn" data-i18n="ota_open">Update-Seite oeffnen</button>
          <div class="help-text" data-i18n="help_ota">Nutze nur passende Firmware fuer dieses Geraet. Update nicht waehrend instabiler Versorgung starten.</div>
        </div>

        <div class="sub-card" id="settingsSection">
          <div class="sub-title" data-i18n="system_actions_title">Systemaktionen</div>
          <button type="button" class="btn" id="saveSettingsBtn" data-i18n="settings_save">Alle Einstellungen speichern</button>
          <div class="row-two" style="margin-top:8px;">
            <button type="button" class="btn" id="restartNormalBtn" data-i18n="restart_normal">Normal neu starten</button>
            <button type="button" class="btn" id="restartPowerBtn" data-i18n="restart_power">Power-Modus starten</button>
          </div>
          <div class="help-text" data-i18n="help_system_actions">Alle Einstellungen speichern betrifft Sollwerte, Sensor-Zuordnung, Batterie-Zellen und das Manual-Fenster. WLAN bleibt separat.</div>
        </div>

        <div class="sub-card" id="diagSection">
          <div class="sub-title" data-i18n="diag_title">Diagnose</div>
          <div class="row-two" style="margin-bottom:8px;">
            <div class="field">
              <label for="battery1Cells" data-i18n="diag_batt1_cells">Batterie 1 Zellen</label>
              <select id="battery1Cells" class="mock-input">
                <option value="2">2S</option>
                <option value="3">3S</option>
                <option value="4">4S</option>
                <option value="5">5S</option>
                <option value="6">6S</option>
              </select>
            </div>
            <div class="field">
              <label for="battery2Cells" data-i18n="diag_batt2_cells">Batterie 2 Zellen</label>
              <select id="battery2Cells" class="mock-input">
                <option value="2">2S</option>
                <option value="3">3S</option>
                <option value="4">4S</option>
                <option value="5">5S</option>
                <option value="6">6S</option>
              </select>
            </div>
          </div>
          <div class="field" style="margin-bottom:8px;">
            <label for="manualToggleWindowInput" data-i18n="diag_manual_window_input">Manual OFF/ON Fenster (ms)</label>
            <input type="number" id="manualToggleWindowInput" class="mock-input" min="100" max="5000" step="50" value="1500">
          </div>
          <div class="help-text" data-i18n="help_diag_manual">Dieses Fenster bestimmt, wie lange eine Batterie maximal aus sein darf, damit ein Manual-Schaltimpuls erkannt wird.</div>
          <div class="diag-grid">
            <div class="diag-item"><span data-i18n="diag_boot">Boot Pin</span><b id="bootPinState">-</b></div>
            <div class="diag-item"><span data-i18n="diag_manual_window">Manual-Fenster</span><b id="manualToggleWindowDisplay">-</b></div>
            <div class="diag-item"><span data-i18n="diag_adc1">ADC1</span><b id="adc1Value">-</b></div>
            <div class="diag-item"><span data-i18n="diag_adc2">ADC2</span><b id="adc2Value">-</b></div>
            <div class="diag-item"><span data-i18n="diag_ntc1">MOSFET 1 NTC</span><b id="diagNtc1">-</b></div>
            <div class="diag-item"><span data-i18n="diag_ntc2">MOSFET 2 NTC</span><b id="diagNtc2">-</b></div>
            <div class="diag-item"><span data-i18n="diag_mosfet1_protect">MOSFET 1 Schutz</span><b id="diagMosfet1Protect">-</b></div>
            <div class="diag-item"><span data-i18n="diag_mosfet2_protect">MOSFET 2 Schutz</span><b id="diagMosfet2Protect">-</b></div>
            <div class="diag-item"><span data-i18n="diag_battery1">Batterie 1</span><b id="diagBatt1">-</b></div>
            <div class="diag-item"><span data-i18n="diag_battery2">Batterie 2</span><b id="diagBatt2">-</b></div>
          </div>
          <div class="diag-action-row">
            <button type="button" class="btn" id="vibrationTestBtn" data-i18n="vibration_test">Vibration testen</button>
            <button type="button" class="btn" id="serialToggle" data-i18n="serial_button">Serielles Protokoll</button>
            <button type="button" class="btn warn" id="resetOvertempBtn" data-i18n="overtemp_reset_btn">MOSFET Overtemp-Historie reset</button>
          </div>
          <div class="serial-preview hidden" id="serialPreview">Keine Logdaten geladen.</div>
        </div>
      </div>
    </section>
  </main>

  <div class="toast" id="toast">Gespeichert</div>

  <script>
  const USER_EDIT_HOLD_MS = 10000;
  const TEMP_PUSH_DEBOUNCE_MS = 350;

  const advancedToggle = document.getElementById('advancedToggle');
  const helpToggleBtn = document.getElementById('helpToggleBtn');
  const advancedPanel = document.getElementById('advancedPanel');
  const toast = document.getElementById('toast');
  const serialToggle = document.getElementById('serialToggle');
  const serialPreview = document.getElementById('serialPreview');
  const langToggleBtn = document.getElementById('langToggleBtn');
  const modePill = document.getElementById('modePill');
  const modeHelpBox = document.getElementById('modeHelpBox');

  const temp1Slider = document.getElementById('temp1Slider');
  const temp2Slider = document.getElementById('temp2Slider');
  const targetTemp1Display = document.getElementById('targetTemp1Display');
  const targetTemp2Display = document.getElementById('targetTemp2Display');
  const currentTemp1Display = document.getElementById('currentTemp1Display');
  const currentTemp2Display = document.getElementById('currentTemp2Display');
  const statusRing1 = document.getElementById('statusRing1');
  const statusRing2 = document.getElementById('statusRing2');
  const status1Pct = document.getElementById('status1Pct');
  const status2Pct = document.getElementById('status2Pct');
  const heater1ProtectBadge = document.getElementById('heater1ProtectBadge');
  const heater2ProtectBadge = document.getElementById('heater2ProtectBadge');

  const swapSensorsInput = document.getElementById('swapSensorsInput');
  const swapOffLabel = document.getElementById('swapOffLabel');
  const swapOnLabel = document.getElementById('swapOnLabel');
  const ssidInput = document.getElementById('ssidInput');
  const passwordInput = document.getElementById('passwordInput');
  const battery1Cells = document.getElementById('battery1Cells');
  const battery2Cells = document.getElementById('battery2Cells');
  const manualToggleWindowInput = document.getElementById('manualToggleWindowInput');

  const saveWifiBtn = document.getElementById('saveWifiBtn');
  const saveSettingsBtn = document.getElementById('saveSettingsBtn');
  const restartNormalBtn = document.getElementById('restartNormalBtn');
  const restartPowerBtn = document.getElementById('restartPowerBtn');
  const resetRuntimeBtn = document.getElementById('resetRuntimeBtn');
  const otaOpenBtn = document.getElementById('otaOpenBtn');
  const checkUpdateBtn = document.getElementById('checkUpdateBtn');
  const autoUpdateBtn = document.getElementById('autoUpdateBtn');
  const vibrationTestBtn = document.getElementById('vibrationTestBtn');
  const resetOvertempBtn = document.getElementById('resetOvertempBtn');

  const runtimeTotal = document.getElementById('runtimeTotal');
  const runtimeCurrent = document.getElementById('runtimeCurrent');
  const bootPinState = document.getElementById('bootPinState');
  const manualToggleWindowDisplay = document.getElementById('manualToggleWindowDisplay');
  const adc1Value = document.getElementById('adc1Value');
  const adc2Value = document.getElementById('adc2Value');
  const diagNtc1 = document.getElementById('diagNtc1');
  const diagNtc2 = document.getElementById('diagNtc2');
  const diagMosfet1Protect = document.getElementById('diagMosfet1Protect');
  const diagMosfet2Protect = document.getElementById('diagMosfet2Protect');
  const diagBatt1 = document.getElementById('diagBatt1');
  const diagBatt2 = document.getElementById('diagBatt2');
  const summarySsid = document.getElementById('summarySsid');
  const firmwareVersion = document.getElementById('firmwareVersion');
  const updateBanner = document.getElementById('updateBanner');

  let toastTimer = null;
  let userEditingUntilMs = 0;
  let currentLang = 'de';
  let showHelp = false;
  let showModeHelp = false;
  let tempPushTimer = null;
  let tempPushInFlight = false;
  let tempPushQueued = false;

  const state = {
    temp1: 23.0,
    temp2: 23.0,
    current1: 0,
    current2: 0,
    swap: false,
    batt1Cells: 3,
    batt2Cells: 3,
    windowMs: 1500,
    modeLabel: 'AUTO',
    localVersion: '',
    remoteVersion: '',
    remoteFirmwareUrl: '',
    updateAvailable: false
  };

  const i18n = {
    de: {
      mode_auto: 'AUTO',
      summary_ap_ip: 'AP IP',
      summary_firmware: 'Firmware',
      summary_ssid: 'WLAN',
      update_available: 'Neue Version verfuegbar: {version}',
      heater1_title: 'Heizung 1',
      heater2_title: 'Heizung 2',
      slider_target: 'Sollwert',
      mode_auto_label: 'AUTO:',
      mode_auto_desc: 'Automatische Regelung fuer beide Heizkreise anhand der Solltemperaturen.',
      mode_power_label: 'POWER:',
      mode_power_desc: 'Beide Heizkreise werden im Leistungsmodus priorisiert betrieben.',
      mode_manual_label: 'MANUAL:',
      mode_manual_desc: 'Manuelle Steuerung fuer beide Heizkreise mit festen Leistungswerten.',
      advanced_show: 'Erweitert anzeigen',
      advanced_hide: 'Erweitert ausblenden',
      help_toggle_show: 'Hilfe anzeigen',
      help_toggle_hide: 'Hilfe ausblenden',
      sensor_title: 'Sensor-Zuordnung',
      sensor_swap_title: 'Temperaturfuehler tauschen',
      sensor_swap_desc: 'Bei vertauschter Verkabelung aktivieren.',
      off: 'AUS',
      on: 'EIN',
      wifi_title: 'WLAN Einstellungen',
      wifi_ssid: 'Netzwerkname (SSID)',
      wifi_pass: 'Passwort',
      wifi_save: 'WLAN speichern (mit Neustart)',
      runtime_title: 'System Laufzeit',
      runtime_total: 'Gesamtlaufzeit',
      runtime_current: 'Aktuelle Laufzeit',
      runtime_reset: 'Gesamtlaufzeit zuruecksetzen',
      ota_title: 'Firmware Update (OTA)',
      ota_hint: 'Lade eine neue firmware.bin hoch, um das Geraet zu aktualisieren.',
      update_check_btn: 'Auf Update pruefen',
      update_auto_btn: 'Automatisch aktualisieren',
      ota_open: 'Update-Seite oeffnen',
      system_actions_title: 'Systemaktionen',
      settings_save: 'Alle Einstellungen speichern',
      restart_normal: 'Normal neu starten',
      restart_power: 'Power-Modus starten',
      diag_title: 'Diagnose',
      diag_batt1_cells: 'Batterie 1 Zellen',
      diag_batt2_cells: 'Batterie 2 Zellen',
      diag_manual_window_input: 'Manual OFF/ON Fenster (ms)',
      diag_boot: 'Boot Pin',
      diag_manual_window: 'Manual-Fenster',
      diag_adc1: 'ADC1',
      diag_adc2: 'ADC2',
      diag_ntc1: 'MOSFET 1 NTC',
      diag_ntc2: 'MOSFET 2 NTC',
      diag_mosfet1_protect: 'MOSFET 1 Schutz',
      diag_mosfet2_protect: 'MOSFET 2 Schutz',
      diag_battery1: 'Batterie 1',
      diag_battery2: 'Batterie 2',
      diag_overtemp_active: 'MOSFET HEISS',
      diag_overtemp_cooling: 'kuehlt',
      diag_overtemp_trip: 'MOSFET Vorfall',
      diag_overtemp_ok: 'OK',
      vibration_test: 'Vibration testen',
      overtemp_reset_btn: 'MOSFET Overtemp-Historie reset',
      serial_button: 'Serielles Protokoll',
      badge_hot: 'MOSFET HEISS',
      badge_trip: 'MOSFET VORFALL',
      help_sensor_swap: 'Nur aktivieren, wenn Heizung 1/2 offensichtlich vertauscht reagieren.',
      help_wifi: 'Nach dem WLAN-Speichern ist ein Neustart notwendig, damit die neuen Daten aktiv werden.',
      help_captive_desktop: 'Desktop ohne Auto-Weiterleitung: im Browser direkt http://4.3.2.1 oeffnen.',
      help_runtime_reset: 'Diese Aktion setzt nur den Laufzeitzaehler zurueck. Heizparameter bleiben unveraendert.',
      help_ota: 'Nutze nur passende Firmware fuer dieses Geraet. Update nicht waehrend instabiler Versorgung starten.',
      help_system_actions: 'Alle Einstellungen speichern betrifft Sollwerte, Sensor-Zuordnung, Batterie-Zellen und das Manual-Fenster. WLAN bleibt separat.',
      help_diag_manual: 'Dieses Fenster bestimmt, wie lange eine Batterie maximal aus sein darf, damit ein Manual-Schaltimpuls erkannt wird.',
      lang_toggle: 'English',
      toast_saved: 'Gespeichert',
      toast_wifi_saved: 'WLAN gespeichert. Neustart...',
      toast_wifi_error: 'WLAN konnte nicht gespeichert werden',
      toast_settings_saved: 'Alle Einstellungen gespeichert',
      toast_settings_error: 'Speichern fehlgeschlagen',
      toast_restart_normal: 'Normaler Neustart gestartet',
      toast_restart_power: 'Power-Neustart gestartet',
      toast_runtime_reset: 'Gesamtlaufzeit zurueckgesetzt',
      toast_vibration_ok: 'Vibrationstest gestartet',
      toast_overtemp_reset: 'MOSFET Overtemp-Historie geloescht',
      toast_serial_open: 'Serielles Protokoll geoeffnet',
      toast_serial_close: 'Serielles Protokoll geschlossen',
      toast_ota: 'OTA Seite wird geoeffnet',
      toast_update_checking: 'Pruefe auf neue Version...',
      toast_update_none: 'Keine neuere Version gefunden',
      toast_update_found: 'Neue Version gefunden: {version}',
      toast_update_unavailable: 'Update-Check aktuell nicht verfuegbar',
      toast_auto_update_start: 'Auto-Update wird vorbereitet...',
      toast_auto_update_download: 'Firmware wird geladen...',
      toast_auto_update_upload: 'Firmware wird auf das Geraet geladen...',
      toast_auto_update_done: 'Update gestartet. Geraet startet neu',
      toast_auto_update_no_asset: 'Kein passendes .bin Release gefunden',
      toast_auto_update_failed: 'Auto-Update fehlgeschlagen',
      confirm_auto_update: 'Automatisches Update jetzt starten?',
      confirm_auto_update_force_same: 'Aktuelle Version bereits installiert ({version}). Trotzdem Update erneut durchfuehren?',
      confirm_restart_normal: 'Geraet im Normalmodus neu starten?',
      confirm_restart_power: 'Geraet im Power-Modus neu starten?',
      confirm_overtemp_reset: 'MOSFET Overtemp-Historie wirklich loeschen?',
      confirm_runtime_reset: 'Gesamtlaufzeit wirklich zuruecksetzen?',
      current_not_connected: 'Nicht verbunden',
      current_prefix: 'Ist',
      serial_empty: 'Keine Logdaten vorhanden.'
    },
    en: {
      mode_auto: 'AUTO',
      summary_ap_ip: 'AP IP',
      summary_firmware: 'Firmware',
      summary_ssid: 'WiFi',
      update_available: 'New version available: {version}',
      heater1_title: 'Heating 1',
      heater2_title: 'Heating 2',
      slider_target: 'Target',
      mode_auto_label: 'AUTO:',
      mode_auto_desc: 'Automatic control for both heating zones based on target temperatures.',
      mode_power_label: 'POWER:',
      mode_power_desc: 'Both heating zones are prioritized in power mode.',
      mode_manual_label: 'MANUAL:',
      mode_manual_desc: 'Manual control for both heating zones with fixed power levels.',
      advanced_show: 'Show advanced',
      advanced_hide: 'Hide advanced',
      help_toggle_show: 'Show help',
      help_toggle_hide: 'Hide help',
      sensor_title: 'Sensor assignment',
      sensor_swap_title: 'Swap temperature sensors',
      sensor_swap_desc: 'Enable when sensor wiring is reversed.',
      off: 'OFF',
      on: 'ON',
      wifi_title: 'WiFi settings',
      wifi_ssid: 'Network name (SSID)',
      wifi_pass: 'Password',
      wifi_save: 'Save WiFi (with restart)',
      runtime_title: 'System runtime',
      runtime_total: 'Total runtime',
      runtime_current: 'Current runtime',
      runtime_reset: 'Reset total runtime',
      ota_title: 'Firmware update (OTA)',
      ota_hint: 'Upload a new firmware.bin to update the device.',
      update_check_btn: 'Check for updates',
      update_auto_btn: 'Auto update',
      ota_open: 'Open update page',
      system_actions_title: 'System actions',
      settings_save: 'Save all settings',
      restart_normal: 'Restart normal mode',
      restart_power: 'Restart power mode',
      diag_title: 'Diagnostics',
      diag_batt1_cells: 'Battery 1 cells',
      diag_batt2_cells: 'Battery 2 cells',
      diag_manual_window_input: 'Manual OFF/ON window (ms)',
      diag_boot: 'Boot pin',
      diag_manual_window: 'Manual window',
      diag_adc1: 'ADC1',
      diag_adc2: 'ADC2',
      diag_ntc1: 'MOSFET 1 NTC',
      diag_ntc2: 'MOSFET 2 NTC',
      diag_mosfet1_protect: 'MOSFET 1 protection',
      diag_mosfet2_protect: 'MOSFET 2 protection',
      diag_battery1: 'Battery 1',
      diag_battery2: 'Battery 2',
      diag_overtemp_active: 'MOSFET HOT',
      diag_overtemp_cooling: 'cooling',
      diag_overtemp_trip: 'MOSFET event',
      diag_overtemp_ok: 'OK',
      vibration_test: 'Test vibration',
      overtemp_reset_btn: 'Reset MOSFET overtemp history',
      serial_button: 'Serial log',
      badge_hot: 'MOSFET HOT',
      badge_trip: 'MOSFET EVENT',
      help_sensor_swap: 'Only enable this when heating zone behavior is clearly swapped.',
      help_wifi: 'After saving WiFi, a restart is required before new credentials are active.',
      help_captive_desktop: 'If desktop captive portal does not open, open http://4.3.2.1 directly in the browser.',
      help_runtime_reset: 'This action only resets runtime counters. Heating parameters stay unchanged.',
      help_ota: 'Use only matching firmware for this device. Do not update with unstable power.',
      help_system_actions: 'Save all settings stores targets, sensor mapping, battery cells, and manual window. WiFi remains separate.',
      help_diag_manual: 'This window defines how long a battery may be OFF for manual toggle detection.',
      lang_toggle: 'Deutsch',
      toast_saved: 'Saved',
      toast_wifi_saved: 'WiFi saved. Rebooting...',
      toast_wifi_error: 'Could not save WiFi',
      toast_settings_saved: 'All settings saved',
      toast_settings_error: 'Save failed',
      toast_restart_normal: 'Normal restart initiated',
      toast_restart_power: 'Power restart initiated',
      toast_runtime_reset: 'Total runtime reset',
      toast_vibration_ok: 'Vibration test started',
      toast_overtemp_reset: 'MOSFET overtemp history cleared',
      toast_serial_open: 'Serial log opened',
      toast_serial_close: 'Serial log closed',
      toast_ota: 'Opening OTA page',
      toast_update_checking: 'Checking for updates...',
      toast_update_none: 'No newer version found',
      toast_update_found: 'New version found: {version}',
      toast_update_unavailable: 'Update check is currently unavailable',
      toast_auto_update_start: 'Preparing auto update...',
      toast_auto_update_download: 'Downloading firmware...',
      toast_auto_update_upload: 'Uploading firmware to device...',
      toast_auto_update_done: 'Update started. Device will reboot',
      toast_auto_update_no_asset: 'No matching .bin release asset found',
      toast_auto_update_failed: 'Auto update failed',
      confirm_auto_update: 'Start automatic update now?',
      confirm_auto_update_force_same: 'This version ({version}) is already installed. Run the update again anyway?',
      confirm_restart_normal: 'Restart device in normal mode?',
      confirm_restart_power: 'Restart device in power mode?',
      confirm_overtemp_reset: 'Clear MOSFET overtemp history now?',
      confirm_runtime_reset: 'Reset total runtime?',
      current_not_connected: 'Not connected',
      current_prefix: 'Current',
      serial_empty: 'No log entries yet.'
    }
  };

  function t(key) {
    return (i18n[currentLang] && i18n[currentLang][key]) || key;
  }

  function markUserEditing() {
    userEditingUntilMs = Date.now() + USER_EDIT_HOLD_MS;
  }

  function isUserEditing() {
    return Date.now() < userEditingUntilMs;
  }

  function clampTemp(value) {
    return Math.min(45, Math.max(10, Number(value) || 23));
  }

  function showToast(message) {
    toast.textContent = message;
    toast.classList.add('show');
    if (toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toast.classList.remove('show'), 1700);
  }

  function fillTemplate(template, values) {
    let text = String(template || '');
    Object.keys(values || {}).forEach((key) => {
      text = text.replace(new RegExp(`\\{${key}\\}`, 'g'), String(values[key]));
    });
    return text;
  }

  function parseVersion(value) {
    const source = String(value || '').trim().replace(/^v/i, '');
    const match = source.match(/\d+(?:\.\d+)*/);
    if (!match) return [];
    return match[0].split('.').map((part) => Number(part));
  }

  function compareVersions(a, b) {
    const av = parseVersion(a);
    const bv = parseVersion(b);
    if (av.length === 0 || bv.length === 0) return 0;
    const maxLen = Math.max(av.length, bv.length);
    for (let i = 0; i < maxLen; i += 1) {
      const left = av[i] || 0;
      const right = bv[i] || 0;
      if (left > right) return 1;
      if (left < right) return -1;
    }
    return 0;
  }

  function renderUpdateBanner() {
    if (!updateBanner) return;
    if (!state.updateAvailable || !state.remoteVersion) {
      updateBanner.textContent = '';
      updateBanner.classList.add('hidden');
      return;
    }
    updateBanner.textContent = fillTemplate(t('update_available'), { version: state.remoteVersion });
    updateBanner.classList.remove('hidden');
  }

  async function fetchWithTimeout(url, options, timeoutMs) {
    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), timeoutMs);
    try {
      const response = await fetch(url, { ...(options || {}), signal: controller.signal });
      return response;
    } finally {
      clearTimeout(timer);
    }
  }

  async function fetchLatestReleaseInfo() {
    let releaseVersion = '';
    let releaseFirmwareUrl = '';
    const rawFirmwareUrl = 'https://raw.githubusercontent.com/BubTec/HeatControl/main/firmware/firmware.bin';

    try {
      console.log('[update] fetching latest GitHub release info');
      const releaseResponse = await fetchWithTimeout(
        'https://api.github.com/repos/BubTec/HeatControl/releases/latest',
        { headers: { Accept: 'application/vnd.github+json' } },
        5000
      );

      if (releaseResponse.ok) {
        const payload = await releaseResponse.json();
        const tag = typeof payload.tag_name === 'string' ? payload.tag_name.trim() : '';
        if (tag) {
          releaseVersion = tag;
          releaseFirmwareUrl = rawFirmwareUrl;
        }

        const assets = Array.isArray(payload.assets) ? payload.assets : [];
        const binCandidates = assets
          .map((asset) => {
            const name = typeof asset.name === 'string' ? asset.name : '';
            const url = typeof asset.browser_download_url === 'string' ? asset.browser_download_url : '';
            const size = typeof asset.size === 'number' ? asset.size : 0;
            return { name, url, size };
          })
          .filter((asset) => /\.bin$/i.test(asset.name) && asset.url.length > 0);

        binCandidates.sort((a, b) => {
          const aIsFirmware = /^firmware\.bin$/i.test(a.name) ? 1 : 0;
          const bIsFirmware = /^firmware\.bin$/i.test(b.name) ? 1 : 0;
          if (aIsFirmware !== bIsFirmware) return bIsFirmware - aIsFirmware;
          return (b.size || 0) - (a.size || 0);
        });

        if (binCandidates.length > 0) {
          console.log('[update] release assets found, selected metadata asset', binCandidates[0]);
        }
        console.log('[update] using CORS-safe firmware URL', releaseFirmwareUrl || rawFirmwareUrl);
      } else {
        console.warn('[update] GitHub release API request failed', releaseResponse.status);
      }
    } catch (_) {
      // keep fallback path
      console.warn('[update] GitHub release API request errored');
    }

    if (releaseVersion) {
      return { version: releaseVersion, firmwareUrl: releaseFirmwareUrl };
    }

    try {
      const rawResponse = await fetchWithTimeout(
        'https://raw.githubusercontent.com/BubTec/HeatControl/main/upload/version.txt',
        {},
        5000
      );
      if (!rawResponse.ok) {
        return { version: '', firmwareUrl: '' };
      }
      return { version: (await rawResponse.text()).trim(), firmwareUrl: rawFirmwareUrl };
    } catch (_) {
      return { version: '', firmwareUrl: '' };
    }
  }

  async function checkForUpdate() {
    const local = state.localVersion || String(firmwareVersion.textContent || '').trim();
    if (!local || local === '-') return 'unavailable';

    const releaseInfo = await fetchLatestReleaseInfo();
    if (!releaseInfo.version) return 'unavailable';

    state.remoteVersion = releaseInfo.version;
    state.remoteFirmwareUrl = releaseInfo.firmwareUrl || '';
    state.updateAvailable = compareVersions(releaseInfo.version, local) > 0;
    console.log('[update] local', local, 'remote', state.remoteVersion, 'available', state.updateAvailable, 'url', state.remoteFirmwareUrl);
    renderUpdateBanner();
    return state.updateAvailable ? 'available' : 'none';
  }

  async function handleManualUpdateCheck() {
    showToast(t('toast_update_checking'));
    const status = await checkForUpdate();
    if (status === 'available') {
      showToast(fillTemplate(t('toast_update_found'), { version: state.remoteVersion }));
      return;
    }
    if (status === 'none') {
      showToast(t('toast_update_none'));
      return;
    }
    showToast(t('toast_update_unavailable'));
  }

  async function startAutoUpdate() {
    console.log('[update] auto update requested');

    const status = await checkForUpdate();
    if (status === 'unavailable') {
      showToast(t('toast_update_unavailable'));
      console.warn('[update] update status unavailable');
      return;
    }
    if (status === 'available') {
      if (!confirm(t('confirm_auto_update'))) return;
    }
    if (status === 'none') {
      const versionText = state.remoteVersion || state.localVersion || String(firmwareVersion.textContent || '').trim() || '-';
      const confirmText = fillTemplate(t('confirm_auto_update_force_same'), { version: versionText });
      if (!confirm(confirmText)) {
        showToast(t('toast_update_none'));
        console.log('[update] no newer version (force update canceled)');
        return;
      }
      console.log('[update] no newer version, forcing update by user confirmation');
    }

    if (!state.remoteFirmwareUrl) {
      showToast(t('toast_auto_update_no_asset'));
      console.warn('[update] no firmware URL in latest release');
      return;
    }

    try {
      showToast(t('toast_auto_update_start'));
      showToast(t('toast_auto_update_download'));
      console.log('[update] downloading firmware', state.remoteFirmwareUrl);
      const firmwareResponse = await fetchWithTimeout(state.remoteFirmwareUrl, {}, 120000);
      if (!firmwareResponse.ok) {
        throw new Error(`DL_${firmwareResponse.status}`);
      }

      const firmwareBlob = await firmwareResponse.blob();
      if (!firmwareBlob || firmwareBlob.size < 1024) {
        throw new Error('DL_EMPTY');
      }
      console.log('[update] downloaded bytes', firmwareBlob.size);

      showToast(t('toast_auto_update_upload'));
      const form = new FormData();
      const fileName = `HeatControl-${state.remoteVersion || 'latest'}.bin`;
      form.append('firmware', firmwareBlob, fileName);

      console.log('[update] uploading firmware to /update as', fileName);
      const uploadResponse = await fetch('/update', { method: 'POST', body: form });
      console.log('[update] upload response', uploadResponse.status);
      if (!uploadResponse.ok) {
        throw new Error(`UP_${uploadResponse.status}`);
      }

      showToast(t('toast_auto_update_done'));
      console.log('[update] auto update finished (device should reboot)');
    } catch (_) {
      console.error('[update] auto update failed');
      showToast(t('toast_auto_update_failed'));
    }
  }

  function setAdvanced(open) {
    advancedPanel.classList.toggle('hidden', !open);
    advancedToggle.textContent = open ? t('advanced_hide') : t('advanced_show');
  }

  function setHelpVisibility(show) {
    showHelp = show;
    document.body.classList.toggle('show-help', showHelp);
    helpToggleBtn.textContent = showHelp ? t('help_toggle_hide') : t('help_toggle_show');
  }

  function setModeHelpVisibility(show) {
    showModeHelp = show;
    modeHelpBox.classList.toggle('hidden', !showModeHelp);
    modePill.classList.toggle('help-open', showModeHelp);
  }

  function updateSwapVisual() {
    swapOffLabel.classList.toggle('active', !state.swap);
    swapOnLabel.classList.toggle('active', state.swap);
  }

  function setTempDisplay(channel, value) {
    const fixed = clampTemp(value).toFixed(1);
    if (channel === 1) {
      state.temp1 = Number(fixed);
      temp1Slider.value = fixed;
      targetTemp1Display.textContent = fixed;
    } else {
      state.temp2 = Number(fixed);
      temp2Slider.value = fixed;
      targetTemp2Display.textContent = fixed;
    }
  }

  function adjustTemp(channel, delta) {
    markUserEditing();
    const cur = channel === 1 ? state.temp1 : state.temp2;
    setTempDisplay(channel, cur + delta);
    scheduleTempPush();
  }

  function isSensorDisconnected(temp) {
    return Number(temp) <= -126.5;
  }

  function formatCurrentTemp(temp) {
    if (isSensorDisconnected(temp)) {
      return t('current_not_connected');
    }
    return `${t('current_prefix')} ${Number(temp).toFixed(1)} C`;
  }

  function updateRing(channel, percent) {
    const p = Math.max(0, Math.min(100, Number(percent) || 0));
    if (channel === 1) {
      statusRing1.style.setProperty('--pct', p);
      status1Pct.textContent = `${Math.round(p)}%`;
    } else {
      statusRing2.style.setProperty('--pct', p);
      status2Pct.textContent = `${Math.round(p)}%`;
    }
  }

  async function postForm(url, values) {
    const params = new URLSearchParams();
    Object.keys(values || {}).forEach((k) => {
      const v = values[k];
      if (v === undefined || v === null) return;
      if (typeof v === 'boolean') {
        params.append(k, v ? '1' : '0');
      } else {
        params.append(k, String(v));
      }
    });

    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: params.toString()
    });

    if (!response.ok) {
      throw new Error(`HTTP_${response.status}`);
    }
    return response;
  }

  async function pushTempsNow() {
    if (tempPushInFlight) {
      tempPushQueued = true;
      return;
    }

    tempPushInFlight = true;
    try {
      await postForm('/setTemp', { temp1: state.temp1.toFixed(1), temp2: state.temp2.toFixed(1) });
    } catch (err) {
      console.warn('[ui] failed to push set temperatures', err);
    } finally {
      tempPushInFlight = false;
      if (tempPushQueued) {
        tempPushQueued = false;
        void pushTempsNow();
      }
    }
  }

  function scheduleTempPush() {
    if (tempPushTimer) {
      clearTimeout(tempPushTimer);
    }
    tempPushTimer = setTimeout(() => {
      tempPushTimer = null;
      void pushTempsNow();
    }, TEMP_PUSH_DEBOUNCE_MS);
  }

  async function saveAllSettings() {
    try {
      await postForm('/saveSettings', {
        temp1: state.temp1.toFixed(1),
        temp2: state.temp2.toFixed(1),
        swap: state.swap,
        windowMs: Math.round(state.windowMs),
        batt1Cells: state.batt1Cells,
        batt2Cells: state.batt2Cells
      });
      showToast(t('toast_settings_saved'));
      userEditingUntilMs = 0;
      updateStatus();
    } catch (err) {
      try {
        await postForm('/setTemp', { temp1: state.temp1.toFixed(1), temp2: state.temp2.toFixed(1) });
        await postForm('/swapSensors', state.swap ? { swap: 'on' } : {});
        await postForm('/setManualToggle', { windowMs: Math.round(state.windowMs) });
        await postForm('/setBattery1', { cells: state.batt1Cells });
        await postForm('/setBattery2', { cells: state.batt2Cells });
        showToast(t('toast_settings_saved'));
        userEditingUntilMs = 0;
        updateStatus();
      } catch (_) {
        showToast(t('toast_settings_error'));
      }
    }
  }

  async function saveWifi() {
    const ssid = (ssidInput.value || '').trim();
    if (!ssid) {
      showToast(t('toast_wifi_error'));
      return;
    }
    try {
      await postForm('/setWiFi', { ssid: ssid, password: passwordInput.value || '' });
      showToast(t('toast_wifi_saved'));
    } catch (_) {
      showToast(t('toast_wifi_error'));
    }
  }

  async function doRestart(mode) {
    try {
      await postForm('/restart', { mode: mode });
      showToast(mode === 'power' ? t('toast_restart_power') : t('toast_restart_normal'));
    } catch (_) {
      showToast(t('toast_settings_error'));
    }
  }

  async function resetRuntime() {
    try {
      await postForm('/resetRuntime', {});
      showToast(t('toast_runtime_reset'));
      updateStatus();
    } catch (_) {
      showToast(t('toast_settings_error'));
    }
  }

  async function resetOvertempHistory() {
    try {
      await postForm('/resetOvertemp', {});
      showToast(t('toast_overtemp_reset'));
      updateStatus();
    } catch (_) {
      showToast(t('toast_settings_error'));
    }
  }

  async function triggerSignalTest() {
    try {
      await postForm('/signalTest', {});
      showToast(t('toast_vibration_ok'));
    } catch (_) {
      showToast(t('toast_settings_error'));
    }
  }

  async function loadSerialLog() {
    try {
      const response = await fetch('/logs');
      if (!response.ok) throw new Error('LOGS_FAIL');
      const text = await response.text();
      serialPreview.textContent = text.trim() || t('serial_empty');
      serialPreview.scrollTop = serialPreview.scrollHeight;
    } catch (_) {
      serialPreview.textContent = t('serial_empty');
    }
  }

  async function updateVersion() {
    try {
      const response = await fetch('/version.txt');
      if (!response.ok) return;
      const v = (await response.text()).trim();
      firmwareVersion.textContent = v || '-';
      state.localVersion = v || '';
    } catch (_) {
      firmwareVersion.textContent = '-';
      state.localVersion = '';
    }
  }

  function applyLanguage(lang) {
    currentLang = lang === 'en' ? 'en' : 'de';
    document.documentElement.lang = currentLang;

    document.querySelectorAll('[data-i18n]').forEach((el) => {
      const key = el.getAttribute('data-i18n');
      const value = t(key);
      if (value && value !== key) el.textContent = value;
    });

    langToggleBtn.textContent = t('lang_toggle');
    setAdvanced(!advancedPanel.classList.contains('hidden'));
    setHelpVisibility(showHelp);
    setModeHelpVisibility(showModeHelp);
    currentTemp1Display.textContent = formatCurrentTemp(state.current1);
    currentTemp2Display.textContent = formatCurrentTemp(state.current2);
    renderUpdateBanner();
  }

  async function updateStatus() {
    try {
      const response = await fetch('/status');
      if (!response.ok) return;
      const data = await response.json();

      const manual = Number(data.manualMode || 0) === 1;
      if (manual) {
        state.modeLabel = 'MANUAL';
      } else if (String(data.mode || '').toUpperCase().indexOf('POWER') !== -1) {
        state.modeLabel = 'POWER';
      } else {
        state.modeLabel = 'AUTO';
      }
      modePill.textContent = state.modeLabel;

      const current1 = Number(data.current1);
      const current2 = Number(data.current2);
      state.current1 = Number.isFinite(current1) ? current1 : 0;
      state.current2 = Number.isFinite(current2) ? current2 : 0;
      currentTemp1Display.textContent = formatCurrentTemp(state.current1);
      currentTemp2Display.textContent = formatCurrentTemp(state.current2);

      if (!isUserEditing()) {
        setTempDisplay(1, Number(data.target1 || 23));
        setTempDisplay(2, Number(data.target2 || 23));

        state.swap = !!data.swap;
        swapSensorsInput.checked = state.swap;
        updateSwapVisual();

        if (typeof data.batt1Cells === 'number') {
          state.batt1Cells = Number(data.batt1Cells);
          battery1Cells.value = String(state.batt1Cells);
        }
        if (typeof data.batt2Cells === 'number') {
          state.batt2Cells = Number(data.batt2Cells);
          battery2Cells.value = String(state.batt2Cells);
        }
        if (typeof data.manualToggleMaxOffMs === 'number') {
          state.windowMs = Number(data.manualToggleMaxOffMs);
          manualToggleWindowInput.value = String(Math.round(state.windowMs));
        }
        if (typeof data.ssid === 'string' && data.ssid.length > 0) {
          ssidInput.value = data.ssid;
          summarySsid.textContent = data.ssid;
        }
      }

      const out1 = manual ? Number(data.manualPercent1 || 0) : (data.h1 ? 100 : 0);
      const out2 = manual ? Number(data.manualPercent2 || 0) : (data.h2 ? 100 : 0);
      updateRing(1, out1);
      updateRing(2, out2);

      runtimeTotal.textContent = typeof data.totalRuntime === 'string' ? data.totalRuntime : '0m';
      runtimeCurrent.textContent = typeof data.currentRuntime === 'string' ? data.currentRuntime : '0s';
      bootPinState.textContent = typeof data.bootPin === 'string' ? data.bootPin : '-';
      manualToggleWindowDisplay.textContent = typeof data.manualToggleMaxOffMs === 'number' ? `${Math.round(data.manualToggleMaxOffMs)} ms` : '-';
      adc1Value.textContent = typeof data.adc1Mv === 'number' ? `${data.adc1Mv} mV` : '-';
      adc2Value.textContent = typeof data.adc2Mv === 'number' ? `${data.adc2Mv} mV` : '-';

      const ntc1C = typeof data.ntcMosfet1C === 'number' ? Number(data.ntcMosfet1C) : NaN;
      const ntc2C = typeof data.ntcMosfet2C === 'number' ? Number(data.ntcMosfet2C) : NaN;
      const ntc1Mv = typeof data.ntcMosfet1Mv === 'number' ? Math.round(Number(data.ntcMosfet1Mv)) : null;
      const ntc2Mv = typeof data.ntcMosfet2Mv === 'number' ? Math.round(Number(data.ntcMosfet2Mv)) : null;
      diagNtc1.textContent = Number.isFinite(ntc1C) ? `${ntc1C.toFixed(1)} C | ${ntc1Mv !== null ? `${ntc1Mv} mV` : '-'}` : '-';
      diagNtc2.textContent = Number.isFinite(ntc2C) ? `${ntc2C.toFixed(1)} C | ${ntc2Mv !== null ? `${ntc2Mv} mV` : '-'}` : '-';

      const overtempLimitC = typeof data.mosfetOvertempLimitC === 'number' ? Number(data.mosfetOvertempLimitC) : 80;
      const trip1C = typeof data.mosfet1OvertempTripC === 'number' ? Number(data.mosfet1OvertempTripC) : NaN;
      const trip2C = typeof data.mosfet2OvertempTripC === 'number' ? Number(data.mosfet2OvertempTripC) : NaN;
      const protect1Active = Number(data.mosfet1OvertempActive || 0) === 1;
      const protect2Active = Number(data.mosfet2OvertempActive || 0) === 1;
      const protect1Latched = Number(data.mosfet1OvertempLatched || 0) === 1;
      const protect2Latched = Number(data.mosfet2OvertempLatched || 0) === 1;
      const renderProtectState = (active, latched, tripC) => {
        if (active) {
          return `${t('diag_overtemp_active')} | ${t('diag_overtemp_cooling')} | >${overtempLimitC.toFixed(0)} C`;
        }
        if (latched && Number.isFinite(tripC)) {
          return `${t('diag_overtemp_trip')}: ${Number(tripC).toFixed(1)} C`;
        }
        return t('diag_overtemp_ok');
      };
      diagMosfet1Protect.textContent = renderProtectState(
        protect1Active,
        protect1Latched,
        trip1C
      );
      diagMosfet2Protect.textContent = renderProtectState(
        protect2Active,
        protect2Latched,
        trip2C
      );
      const renderProtectBadge = (badgeEl, active, latched) => {
        if (active) {
          badgeEl.textContent = t('badge_hot');
          badgeEl.classList.remove('hidden', 'latched');
          badgeEl.classList.add('active');
          return;
        }
        if (latched) {
          badgeEl.textContent = t('badge_trip');
          badgeEl.classList.remove('hidden', 'active');
          badgeEl.classList.add('latched');
          return;
        }
        badgeEl.textContent = '';
        badgeEl.classList.remove('active', 'latched');
        badgeEl.classList.add('hidden');
      };
      renderProtectBadge(heater1ProtectBadge, protect1Active, protect1Latched);
      renderProtectBadge(heater2ProtectBadge, protect2Active, protect2Latched);

      if (typeof data.batt1V === 'number' && typeof data.batt1Soc === 'number') {
        const c1 = typeof data.batt1CellV === 'number' ? data.batt1CellV.toFixed(2) : '-';
        diagBatt1.textContent = `${Number(data.batt1V).toFixed(2)}V | ${Math.round(Number(data.batt1Soc))}% | ${c1}V/Cell`;
      } else {
        diagBatt1.textContent = '-';
      }

      if (typeof data.batt2V === 'number' && typeof data.batt2Soc === 'number') {
        const c2 = typeof data.batt2CellV === 'number' ? data.batt2CellV.toFixed(2) : '-';
        diagBatt2.textContent = `${Number(data.batt2V).toFixed(2)}V | ${Math.round(Number(data.batt2Soc))}% | ${c2}V/Cell`;
      } else {
        diagBatt2.textContent = '-';
      }
    } catch (_) {
      // ignore polling errors
    }
  }

  advancedToggle.addEventListener('click', () => {
    setAdvanced(advancedPanel.classList.contains('hidden'));
  });

  helpToggleBtn.addEventListener('click', () => {
    setHelpVisibility(!showHelp);
  });

  modePill.addEventListener('click', () => {
    setModeHelpVisibility(!showModeHelp);
  });

  langToggleBtn.addEventListener('click', () => {
    applyLanguage(currentLang === 'de' ? 'en' : 'de');
  });

  temp1Slider.addEventListener('input', () => { markUserEditing(); setTempDisplay(1, temp1Slider.value); scheduleTempPush(); });
  temp2Slider.addEventListener('input', () => { markUserEditing(); setTempDisplay(2, temp2Slider.value); scheduleTempPush(); });
  document.getElementById('temp1DownBtn').addEventListener('click', () => adjustTemp(1, -0.5));
  document.getElementById('temp1UpBtn').addEventListener('click', () => adjustTemp(1, 0.5));
  document.getElementById('temp2DownBtn').addEventListener('click', () => adjustTemp(2, -0.5));
  document.getElementById('temp2UpBtn').addEventListener('click', () => adjustTemp(2, 0.5));

  swapSensorsInput.addEventListener('change', () => {
    markUserEditing();
    state.swap = !!swapSensorsInput.checked;
    updateSwapVisual();
  });

  ssidInput.addEventListener('input', markUserEditing);
  passwordInput.addEventListener('input', markUserEditing);
  battery1Cells.addEventListener('change', () => { markUserEditing(); state.batt1Cells = Number(battery1Cells.value || 3); });
  battery2Cells.addEventListener('change', () => { markUserEditing(); state.batt2Cells = Number(battery2Cells.value || 3); });
  manualToggleWindowInput.addEventListener('input', () => {
    markUserEditing();
    const clamped = Math.min(5000, Math.max(100, Number(manualToggleWindowInput.value || 1500)));
    state.windowMs = clamped;
    manualToggleWindowInput.value = String(Math.round(clamped));
  });

  saveSettingsBtn.addEventListener('click', saveAllSettings);
  saveWifiBtn.addEventListener('click', saveWifi);
  restartNormalBtn.addEventListener('click', () => {
    if (confirm(t('confirm_restart_normal'))) doRestart('normal');
  });
  restartPowerBtn.addEventListener('click', () => {
    if (confirm(t('confirm_restart_power'))) doRestart('power');
  });
  resetRuntimeBtn.addEventListener('click', () => {
    if (confirm(t('confirm_runtime_reset'))) resetRuntime();
  });
  resetOvertempBtn.addEventListener('click', () => {
    if (confirm(t('confirm_overtemp_reset'))) resetOvertempHistory();
  });
  otaOpenBtn.addEventListener('click', () => {
    showToast(t('toast_ota'));
    setTimeout(() => { window.location.href = '/update'; }, 200);
  });
  checkUpdateBtn.addEventListener('click', handleManualUpdateCheck);
  autoUpdateBtn.addEventListener('click', startAutoUpdate);
  vibrationTestBtn.addEventListener('click', triggerSignalTest);

  serialToggle.addEventListener('click', () => {
    const open = serialPreview.classList.contains('hidden');
    serialPreview.classList.toggle('hidden', !open);
    showToast(open ? t('toast_serial_open') : t('toast_serial_close'));
    if (open) loadSerialLog();
  });

  applyLanguage('de');
  setAdvanced(false);
  setHelpVisibility(false);
  setModeHelpVisibility(false);
  updateSwapVisual();
  updateVersion().then(checkForUpdate);
  updateStatus();
  // Keep UI status values fresh while page is open.
  setInterval(updateStatus, 2000);
</script>
</body>
</html>


